<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Heatmap - StraySouls</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <style>
        .map-container {
            width: 100%;
            height: 70vh;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            /* Leaflet needs a defined height */
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .legend {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-top: 1rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .dot {
            width: 15px;
            height: 15px;
            border-radius: 50%;
        }
    </style>
</head>

<body>
    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo"><i class="fas fa-paw"></i> StraySouls</a>
            <div class="nav-toggle"><i class="fas fa-bars"></i></div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="report.html">Report Stray</a></li>
                <li><a href="adopt.html">Adopt</a></li>
                <li><a href="medical.html">Medical Help</a></li>
                <li><a href="donate.html">Donate</a></li>
                <li><a href="heatmap.html" class="active">Heatmap</a></li>
            </ul>
        </div>
    </nav>

    <div class="container" style="padding-top: 2rem;">
        <h1 class="text-center mb-1">Stray Animal Density Heatmap</h1>
        <p class="text-center mb-2">Real-time visualization of reported stray animals and critical zones.</p>

        <div class="map-container">
            <div id="map"></div>
        </div>

        <div class="legend">
            <div class="legend-item">
                <div class="dot" style="background: red;"></div> High Urgency
            </div>
            <div class="legend-item">
                <div class="dot" style="background: orange;"></div> Medium Urgency
            </div>
            <div class="legend-item">
                <div class="dot" style="background: green;"></div> Low Urgency
            </div>
        </div>
    </div>

    <script src="js/script.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- Leaflet Heat Plugin -->
    <script src="https://leaflet.github.io/Leaflet.heat/dist/leaflet-heat.js"></script>

    <!-- Socket.io -->
    <script id="socket-script"></script>

    <script>
        const API_BASE = window.location.port === '5500' ? 'http://localhost:3000' : '';
        document.getElementById('socket-script').src = `${API_BASE}/socket.io/socket.io.js`;

        // Initialize Map
        const map = L.map('map').setView([28.6139, 77.2090], 12);

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Heatmap Layer
        // Heatmap points: [lat, lng, intensity]
        let heatData = [];
        const heatLayer = L.heatLayer(heatData, {
            radius: 25,
            blur: 15,
            maxZoom: 17,
            gradient: {
                0.4: 'blue',
                0.6: 'cyan',
                0.7: 'lime',
                0.8: 'yellow',
                1.0: 'red'
            }
        }).addTo(map);

        // Marker Icons & Logic
        const addMarker = (report) => {
            // Friendly Name Logic
            const names = ["Buddy", "Max", "Bella", "Charlie", "Lucy", "Daisy", "Rocky", "Luna", "Coco", "Milo", "Teddy", "Sadie", "Ruby", "Zeus", "Oliver", "Leo", "Duke", "Bear", "Tucker", "Jack", "Penny", "Bailey", "Chloe", "Lola"];
            let hash = 0;
            if (report._id) {
                for (let i = 0; i < report._id.length; i++) {
                    hash = report._id.charCodeAt(i) + ((hash << 5) - hash);
                }
            }
            const friendlyName = names[Math.abs(hash) % names.length];
            const displayName = `${friendlyName} (Stray ${report.animalType ? report.animalType.toUpperCase() : 'ANIMAL'})`;

            // Image URL Logic
            let imageUrl = report.image || '';
            if (imageUrl && !imageUrl.startsWith('http')) {
                imageUrl = `${API_BASE}/` + imageUrl;
            }

            const popupContent = `
                <b>${displayName}</b><br>
                Urgency: ${report.urgency}<br>
                Location: ${report.location.address || `${report.location.lat.toFixed(4)}, ${report.location.lng.toFixed(4)}`}<br>
                ${report.description ? report.description : ''}<br>
                <img src="${imageUrl}" style="width:100px; margin-top:5px; border-radius:4px;" onerror="this.onerror=null;this.src='images/placeholder.svg';">
                <br><a href="https://www.google.com/maps?q=${report.location.lat},${report.location.lng}" target="_blank" style="font-size: 0.8rem;">Open in Maps</a>
            `;

            const marker = L.circleMarker([report.location.lat, report.location.lng], {
                radius: 5,
                fillColor: "#333",
                color: "#333",
                weight: 1,
                opacity: 0.5,
                fillOpacity: 0.2
            }).addTo(map);

            marker.bindPopup(popupContent);
        };

        const updateHeatmap = (reports) => {
            heatData = reports.map(r => {
                let intensity = 0.5;
                if (r.urgency === 'high') intensity = 1.0;
                else if (r.urgency === 'medium') intensity = 0.7;
                return [r.location.lat, r.location.lng, intensity];
            });
            heatLayer.setLatLngs(heatData);
        };

        // Fetch existing reports
        fetch(`${API_BASE}/api/reports`)
            .then(res => res.json())
            .then(reports => {
                updateHeatmap(reports);
                reports.forEach(report => {
                    addMarker(report);
                });

                // Adjust map view to fit data
                if (reports.length > 0) {
                    const bounds = L.latLngBounds(reports.map(r => [r.location.lat, r.location.lng]));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            })
            .catch(err => console.error('Error fetching reports:', err));

        // Socket.io for Real-time updates
        const socket = io(API_BASE || window.location.origin);

        socket.on('new-report', (report) => {
            addMarker(report);

            // Add to heatmap data
            let intensity = 0.5;
            if (report.urgency === 'high') intensity = 1.0;
            else if (report.urgency === 'medium') intensity = 0.7;

            heatData.push([report.location.lat, report.location.lng, intensity]);
            heatLayer.setLatLngs(heatData);

            // Optional: Toast or notification
            if (typeof showToast === 'function') {
                showToast('New report received in real-time!', 'success');
            }
        });

    </script>
</body>

</html>