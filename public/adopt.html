<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adopt a Pet - StraySouls</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .filter-section {
            background: white;
            padding: 1rem 0;
            margin-bottom: 2rem;
            border-bottom: 1px solid #eee;
        }

        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group select {
            padding: 8px;
            border-radius: var(--radius);
            border: 1px solid #ddd;
        }

        .pets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .pet-card {
            background: white;
            border-radius: var(--radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .pet-card:hover {
            transform: translateY(-5px);
        }

        .pet-image {
            height: 200px;
            width: 100%;
            object-fit: cover;
        }

        .pet-info {
            padding: 1.5rem;
        }

        .pet-name {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pet-details {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .pet-tag {
            background: #f0f0f0;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .status-badge {
            font-size: 0.8rem;
            padding: 4px 8px;
            border-radius: 4px;
            background-color: #e67e22;
            /* Default: Urgent/Info */
            color: white;
        }
    </style>
</head>

<body>

    <nav class="navbar">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <i class="fas fa-paw"></i> StraySouls
            </a>
            <div class="nav-toggle"><i class="fas fa-bars"></i></div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="report.html">Report Stray</a></li>
                <li><a href="adopt.html" class="active">Adopt</a></li>
                <li><a href="medical.html">Medical Help</a></li>
                <li><a href="donate.html">Donate</a></li>
                <li><a href="heatmap.html">Heatmap</a></li>
                <li id="auth-links"><!-- JS Populated --></li>
            </ul>
        </div>
    </nav>

    <!-- Filters -->
    <section class="filter-section">
        <div class="container">
            <div class="filters">
                <h3>Find your friend:</h3>
                <div class="filter-group">
                    <select id="type-filter" onchange="renderPets()">
                        <option value="all">All Types</option>
                        <option value="dog">Dogs</option>
                        <option value="cat">Cats</option>
                    </select>
                </div>
                <div class="filter-group">
                    <select id="age-filter" onchange="renderPets()">
                        <option value="all">Any Age</option>
                        <option value="puppy">Puppy/Kitten (< 1 yr)</option>
                        <option value="adult">Adult (1-7 yrs)</option>
                        <option value="senior">Senior (7+ yrs)</option>
                    </select>
                </div>
            </div>
        </div>
    </section>

    <!-- Content -->
    <div class="container mb-2">
        <h1 class="text-center mb-1">Pets Waiting for a Home</h1>
        <div class="pets-grid" id="pets-container">
            <!-- Pets will be injected here -->
        </div>
    </div>

    <script src="js/script.js"></script>

    <!-- Appointment Modal -->
    <div id="appointment-modal" class="modal hidden">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>Book Appointment</h2>
            <p>Meet <span id="modal-pet-name"></span> at <span id="modal-pet-location"></span></p>
            <form id="appointment-form">
                <input type="hidden" id="modal-pet-id">
                <div class="form-group">
                    <label for="date">Preferred Date</label>
                    <input type="date" id="date" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="message">Message (Optional)</label>
                    <textarea id="message" class="form-control" rows="3"
                        placeholder="Any specific questions?"></textarea>
                </div>
                <button type="submit" id="book-submit-btn" class="btn btn-primary" style="width:100%">Confirm
                    Booking</button>
            </form>
        </div>
    </div>

    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            cursor: pointer;
        }
    </style>

    <script>
        const API_BASE = window.location.port === '5500' ? 'http://localhost:3000' : '';
        let allPets = [];

        async function fetchPets() {
            try {
                const response = await fetch(`${API_BASE}/api/reports`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const reports = await response.json();

                // Helper for Friendly Names
                const getFriendlyName = (id, type) => {
                    if (!id) return "Stray " + (type || "Animal");
                    const names = ["Buddy", "Max", "Bella", "Charlie", "Lucy", "Daisy", "Rocky", "Luna", "Coco", "Milo", "Teddy", "Sadie", "Ruby", "Zeus", "Oliver", "Leo", "Duke", "Bear", "Tucker", "Jack", "Penny", "Bailey", "Chloe", "Lola"];
                    let hash = 0;
                    for (let i = 0; i < id.length; i++) {
                        hash = id.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    return names[Math.abs(hash) % names.length];
                };

                // Helper for Random Locations (Ludhiana)
                const getRandomLocation = (id) => {
                    const locations = [
                        "Sarabha Nagar, Ludhiana", "Model Town, Ludhiana", "Civil Lines, Ludhiana",
                        "BRS Nagar, Ludhiana", "Dugri, Ludhiana", "Ferozepur Road, Ludhiana",
                        "Ghumar Mandi, Ludhiana", "Pakhowal Road, Ludhiana", "Haibowal, Ludhiana",
                        "Kitchlu Nagar, Ludhiana", "Agar Nagar, Ludhiana", "Rishi Nagar, Ludhiana"
                    ];
                    let hash = 0;
                    if (id) {
                        for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
                    }
                    return locations[Math.abs(hash) % locations.length];
                };

                // Transform reports to pets format safely
                allPets = reports.map(report => {
                    try {
                        const cleanType = (report.animalType || 'animal').toLowerCase();
                        const typeMap = {
                            dog: 'dog,puppy',
                            cat: 'cat,kitten',
                            bird: 'bird',
                            other: 'wildlife'
                        };
                        const keyword = typeMap[cleanType] || 'animal';

                        // Reuse hash logic for stable random image
                        let imgHash = 0;
                        if (report._id) {
                            for (let i = 0; i < report._id.length; i++) imgHash = report._id.charCodeAt(i) + ((imgHash << 5) - imgHash);
                        }
                        const lockId = Math.abs(imgHash);
                        // Using lock ensures the same pet always gets the same random image
                        let imageUrl = `https://loremflickr.com/600/400/${keyword}?lock=${lockId}`;

                        const animalType = report.animalType ? report.animalType.charAt(0).toUpperCase() + report.animalType.slice(1) : 'Unknown';
                        const friendlyName = getFriendlyName(report._id, report.animalType);
                        const randomLocation = getRandomLocation(report._id);

                        return {
                            id: report._id,
                            name: `${friendlyName} (Stray ${animalType})`,
                            type: report.animalType ? report.animalType.toLowerCase() : 'other',
                            image: imageUrl,
                            location: randomLocation,
                            vaccinated: false,
                            urgency: report.urgency || 'low'
                        };
                    } catch (e) {
                        console.warn('Skipping invalid report:', report, e);
                        return null;
                    }
                }).filter(pet => pet !== null); // Filter out failed mappings

                renderPets();
            } catch (err) {
                console.error('Error fetching pets:', err);
                showToast('Failed to load pets: ' + err.message, 'error');
            }
        }

        function renderPets() {
            const container = document.getElementById('pets-container');
            const typeFilter = document.getElementById('type-filter').value;
            // Removed age filter logic as we don't have age data yet

            container.innerHTML = '';

            const filtered = allPets.filter(pet => {
                if (typeFilter !== 'all' && pet.type !== typeFilter) return false;
                return true;
            });

            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center">No pets match your criteria.</p>';
                return;
            }

            filtered.forEach(pet => {
                const card = `
                    <div class="pet-card">
                        <img src="${pet.image}" alt="${pet.name}" class="pet-image" onerror="this.onerror=null;this.src='images/placeholder.svg';">
                        <div class="pet-info">
                            <div class="pet-name">
                                ${pet.name}
                                <!-- Urgency badge removed -->
                            </div>
                            <div class="pet-details">
                                <span class="pet-tag">${pet.type}</span>
                            </div>
                            <p class="mb-1"><i class="fas fa-map-marker-alt"></i> ${pet.location}</p>
                            <button class="btn btn-outline" style="width:100%" onclick="openBookingModal('${pet.id}')">Book Appointment</button>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        function getUrgencyColor(urgency) {
            if (urgency === 'high') return '#e74c3c';
            if (urgency === 'medium') return '#f39c12';
            return '#2ecc71';
        }

        // Modal Logic
        const modal = document.getElementById('appointment-modal');
        const closeBtn = document.querySelector('.close-modal');

        function openBookingModal(petId) {
            const user = localStorage.getItem('straySoulsUser');
            if (!user) {
                showToast('Please login to book an appointment', 'error');
                delayedRedirect('login.html');
                return;
            }

            const pet = allPets.find(p => p.id === petId);
            document.getElementById('modal-pet-name').textContent = pet.name;
            document.getElementById('modal-pet-location').textContent = pet.location;
            document.getElementById('modal-pet-id').value = pet.id;

            modal.classList.remove('hidden');
        }

        if (closeBtn) closeBtn.onclick = () => modal.classList.add('hidden');
        window.onclick = (e) => {
            if (e.target == modal) modal.classList.add('hidden');
        }

        // Handle Booking
        const aptForm = document.getElementById('appointment-form');
        if (aptForm) {
            aptForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                const reportId = document.getElementById('modal-pet-id').value;
                const date = document.getElementById('date').value;
                const message = document.getElementById('message').value;
                const token = localStorage.getItem('straySoulsToken');

                const submitBtn = document.getElementById('book-submit-btn');
                const originalText = submitBtn.innerText;
                submitBtn.disabled = true;
                submitBtn.innerText = 'Booking...';

                try {
                    const response = await fetch(`${API_BASE}/api/appointments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-auth-token': token
                        },
                        body: JSON.stringify({ reportId, date, message })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showToast('Appointment booked successfully!', 'success');
                        modal.classList.add('hidden');
                        submitBtn.disabled = false;
                        submitBtn.innerText = originalText;
                    } else {
                        showToast(data.msg || data.error || 'Booking failed', 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerText = originalText;
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Server error', 'error');
                    submitBtn.disabled = false;
                    submitBtn.innerText = originalText;
                }
            });
        }

        // Initialize directly
        fetchPets();
    </script>
</body>

</html>